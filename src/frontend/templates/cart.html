<!--
 Copyright 2020 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

{{ define "cart" }}
    {{ template "header" . }}

    <div {{ with $.platform_css }} class="{{.}}" {{ end }}>
        <span class="platform-flag">
            {{$.platform_name}}
        </span>
    </div>

    <main role="main" class="cart-sections">

        {{ if eq (len $.items) 0 }}
        <section class="empty-cart-section">
            <h3>Your shopping cart is empty!</h3>
            <p>Items you add to your shopping cart will appear here.</p>
            <a class="cymbal-button-primary" href="{{ $.baseUrl }}/" role="button">Continue Shopping</a>
        </section>
        {{ else }}
        <section class="container">
            <div class="row">

                <div class="col-lg-6 col-xl-5 offset-xl-1 cart-summary-section">

                    <div class="row mb-3 py-2">
                        <div class="col-4 pl-md-0">
                            <h3>Cart ({{ $.cart_size }})</h3>
                        </div>
                        <div class="col-8 pr-md-0 text-right">
                            <form method="POST" action="{{ $.baseUrl }}/cart/empty">
                                <button class="cymbal-button-secondary cart-summary-empty-cart-button" type="submit">
                                    Empty Cart
                                </button>
                                <a class="cymbal-button-primary" href="{{ $.baseUrl }}/" role="button">
                                    Continue Shopping
                                </a>
                            </form>
                        </div>
                    </div>

                    {{ range $.items }}
                    <div class="row cart-summary-item-row">
                        <div class="col-md-4 pl-md-0">
                            <a href="{{ $.baseUrl }}/product/{{.Item.Id}}">
                                <img class="img-fluid" alt="" src="{{ $.baseUrl }}{{.Item.Picture}}" />
                            </a>
                        </div>
                        <div class="col-md-8 pr-md-0">
                            <div class="row">
                                <div class="col">
                                    <h4>{{ .Item.Name }}</h4>
                                </div>
                            </div>
                            <div class="row cart-summary-item-row-item-id-row">
                                <div class="col">
                                    SKU #{{ .Item.Id }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    Quantity: {{ .Quantity }}
                                </div>
                                <div class="col pr-md-0 text-right">
                                    <strong>
                                        {{ renderMoney .Price }}
                                    </strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    {{ end }}

                    <div class="row cart-summary-shipping-row">
                        <div class="col pl-md-0">Shipping</div>
                        <div class="col pr-md-0 text-right">{{ renderMoney .shipping_cost }}</div>
                    </div>

                    <div class="row cart-summary-total-row">
                        <div class="col pl-md-0">Total</div>
                        <div class="col pr-md-0 text-right">{{ renderMoney .total_cost }}</div>
                    </div>

                </div>
                
                <!-- Smart Cart Recommendations Section -->
                <div class="col-12 mt-4" id="smart-recommendations-section" style="display: none;">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent d-flex align-items-center">
                            <span class="mr-2">ðŸ¤–</span>
                            <h5 class="mb-0">AI Recommendations</h5>
                            <small class="ml-auto text-muted">Based on your cart</small>
                        </div>
                        <div class="card-body">
                            <div id="smart-recommendations-loading" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="sr-only">Loading recommendations...</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Finding perfect matches...</p>
                            </div>
                            <div id="smart-recommendations-content" style="display: none;">
                                <p id="smart-recommendations-message" class="text-muted mb-3"></p>
                                <div id="smart-recommendations-grid" class="row">
                                    <!-- Recommendations will be populated here -->
                                </div>
                            </div>
                            <div id="smart-recommendations-error" style="display: none;" class="text-center py-3">
                                <p class="text-muted mb-0">Recommendations temporarily unavailable</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5 offset-lg-1 col-xl-4">

                    <form class="cart-checkout-form" action="{{ $.baseUrl }}/cart/checkout" method="POST">

                        <!-- Checkout Assistance Section -->
                        <div id="checkout-assistance-section" style="display: none;">
                            <div class="alert alert-info border-0 shadow-sm mb-4">
                                <div class="d-flex align-items-center">
                                    <span class="mr-2">ðŸ¤–</span>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1">AI Checkout Assistant</h6>
                                        <p id="checkout-guidance-text" class="mb-2 small">Loading personalized checkout guidance...</p>
                                        <div id="checkout-suggestions" class="mb-0">
                                            <!-- Suggestions will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <h3>Shipping Address</h3>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col cymbal-form-field">
                                <label for="email">E-mail Address</label>
                                <input type="email" id="email"
                                    name="email" value="someone@example.com" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col cymbal-form-field">
                                <label for="street_address">Street Address</label>
                                <input type="text" name="street_address"
                                    id="street_address" value="1600 Amphitheatre Parkway" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col cymbal-form-field">
                                <label for="zip_code">Zip Code</label>
                                <input type="text"
                                    name="zip_code" id="zip_code" value="94043" required pattern="\d{4,5}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col cymbal-form-field">
                                <label for="city">City</label>
                                <input type="text" name="city" id="city"
                                    value="Mountain View" required>
                                </div>
                            </div>

                        <div class="form-row">
                            <div class="col-md-5 cymbal-form-field">
                                <label for="state">State</label>
                                <input type="text" name="state" id="state"
                                    value="CA" required>
                            </div>
                            <div class="col-md-7 cymbal-form-field">
                                <label for="country">Country</label>
                                <input type="text" id="country"
                                    placeholder="Country Name"
                                    name="country" value="United States" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <h3 class="payment-method-heading">Payment Method</h3>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col cymbal-form-field">
                                <label for="credit_card_number">Credit Card Number</label>
                                <input type="text" id="credit_card_number"
                                    name="credit_card_number"
                                    placeholder="0000000000000000"
                                    value="4432801561520454"
                                    required pattern="\d{16}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-5 cymbal-form-field">
                                <label for="credit_card_expiration_month">Month</label>
                                <select name="credit_card_expiration_month" id="credit_card_expiration_month">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">January</option>
                                </select>
                                <img src="{{ $.baseUrl }}/static/icons/Hipster_DownArrow.svg" alt="" class="cymbal-dropdown-chevron">
                            </div>
                            <div class="col-md-4 cymbal-form-field">
                                    <label for="credit_card_expiration_year">Year</label>
                                    <select name="credit_card_expiration_year" id="credit_card_expiration_year">
                                    {{ range $i, $y := $.expiration_years}}<option value="{{$y}}"
                                        {{if eq $i 1 -}}
                                            selected="selected"
                                        {{- end}}
                                    >{{$y}}</option>{{end}}
                                    </select>
                                    <img src="{{ $.baseUrl }}/static/icons/Hipster_DownArrow.svg" alt="" class="cymbal-dropdown-chevron">
                                </div>
                            <div class="col-md-3 cymbal-form-field">
                                <label for="credit_card_cvv">CVV</label>
                                <input type="password" id="credit_card_cvv"
                                    name="credit_card_cvv" value="672" required pattern="\d{3}">
                            </div>
                        </div>

                        <div class="form-row justify-content-center">
                            <div class="col text-center">
                                <button class="cymbal-button-primary" type="submit">
                                    Place Order
                                </button>
                            </div>
                        </div>

                    </form>

                </div>

            </div>
        </section>
        {{ end }} <!-- end if $.items -->

    </main>

    {{ if $.recommendations }}
        {{ template "recommendations" $ }}
    {{ end }}

    <script>
    // Smart Cart Recommendations and Checkout Assistance
    document.addEventListener('DOMContentLoaded', function() {
        loadSmartRecommendations();
        loadCheckoutAssistance();
    });
    
    async function loadSmartRecommendations() {
        const recommendationsSection = document.getElementById('smart-recommendations-section');
        const loadingDiv = document.getElementById('smart-recommendations-loading');
        const contentDiv = document.getElementById('smart-recommendations-content');
        const errorDiv = document.getElementById('smart-recommendations-error');
        
        try {
            // Check if smart cart features are enabled
            const flagsResponse = await fetch('{{ $.baseUrl }}/api/feature-flags');
            const flags = await flagsResponse.json();
            
            if (!flags.cart_recommendations_enabled) {
                return; // Don't show recommendations if disabled
            }
            
            // Show the recommendations section
            recommendationsSection.style.display = 'block';
            
            // Load recommendations
            const response = await fetch('{{ $.baseUrl }}/api/cart/recommendations');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Hide loading, show content
            loadingDiv.style.display = 'none';
            
            if (data.recommendations && data.recommendations.length > 0) {
                displayRecommendations(data.recommendations, data.message);
                contentDiv.style.display = 'block';
            } else {
                // Hide the entire section if no recommendations
                recommendationsSection.style.display = 'none';
            }
            
        } catch (error) {
            console.error('Failed to load smart recommendations:', error);
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'block';
        }
    }
    
    function displayRecommendations(recommendations, message) {
        const messageElement = document.getElementById('smart-recommendations-message');
        const gridElement = document.getElementById('smart-recommendations-grid');
        
        if (message) {
            messageElement.textContent = message;
        }
        
        gridElement.innerHTML = '';
        
        recommendations.forEach(product => {
            const productCard = createRecommendationCard(product);
            gridElement.appendChild(productCard);
        });
    }
    
    function createRecommendationCard(product) {
        const colDiv = document.createElement('div');
        colDiv.className = 'col-md-6 col-lg-4 mb-3';
        
        colDiv.innerHTML = `
            <div class="card h-100 border-0 shadow-sm recommendation-card">
                <div class="recommendation-image-container">
                    <img src="${product.picture || '/static/img/products/placeholder.jpg'}" 
                         class="card-img-top recommendation-image" 
                         alt="${product.name || 'Product'}"
                         onerror="this.src='/static/img/products/placeholder.jpg'">
                </div>
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title">${escapeHtml(product.name || 'Unknown Product')}</h6>
                    <p class="card-text text-muted small flex-grow-1">${escapeHtml(truncateText(product.description || '', 100))}</p>
                    <a href="{{ $.baseUrl }}/product/${product.id}" 
                       class="btn btn-outline-primary btn-sm mt-auto">
                        View Product
                    </a>
                </div>
            </div>
        `;
        
        return colDiv;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    
    async function loadCheckoutAssistance() {
        const assistanceSection = document.getElementById('checkout-assistance-section');
        const guidanceText = document.getElementById('checkout-guidance-text');
        const suggestionsDiv = document.getElementById('checkout-suggestions');
        
        try {
            // Check if checkout assistance is enabled
            const flagsResponse = await fetch('{{ $.baseUrl }}/api/feature-flags');
            const flags = await flagsResponse.json();
            
            if (!flags.checkout_assistance_enabled) {
                return; // Don't show assistance if disabled
            }
            
            // Load checkout assistance
            const response = await fetch('{{ $.baseUrl }}/api/checkout/assistance');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Show the assistance section
            assistanceSection.style.display = 'block';
            
            // Update guidance text
            if (data.guidance) {
                guidanceText.textContent = data.guidance;
            }
            
            // Display suggestions
            if (data.suggestions && data.suggestions.length > 0) {
                suggestionsDiv.innerHTML = '';
                const suggestionsList = document.createElement('ul');
                suggestionsList.className = 'list-unstyled mb-0';
                
                data.suggestions.forEach(suggestion => {
                    const listItem = document.createElement('li');
                    listItem.className = 'small text-muted mb-1';
                    listItem.innerHTML = `<span class="mr-1">â€¢</span>${escapeHtml(suggestion)}`;
                    suggestionsList.appendChild(listItem);
                });
                
                suggestionsDiv.appendChild(suggestionsList);
            }
            
            // Add agent-powered indicator
            if (data.agent_powered) {
                const indicator = document.createElement('small');
                indicator.className = 'badge badge-success';
                indicator.textContent = 'AI-Powered';
                guidanceText.parentNode.appendChild(indicator);
            }
            
        } catch (error) {
            console.error('Failed to load checkout assistance:', error);
            // Show basic assistance even if agent fails
            assistanceSection.style.display = 'block';
            guidanceText.textContent = 'Please review your order details before proceeding with checkout.';
            suggestionsDiv.innerHTML = '<small class="text-muted">â€¢ Verify shipping address<br>â€¢ Check payment information</small>';
        }
    }
    </script>

    {{ template "footer" . }}
{{ end }}
