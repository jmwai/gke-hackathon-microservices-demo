<!--
 Copyright 2020 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

{{ define "assistant" }}

{{ template "header" . }}
<div {{ with $.platform_css }} class="{{.}}" {{ end }}>
  <span class="platform-flag">
    {{$.platform_name}}
  </span>
</div>

<main role="main">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div id="chat-modal" class="chat-modal">
          <div id="bot-messages" class="bot-messages">
            <p class="bot-message">
              <span class="bot-message-text">Hi, I'm your AI shopping assistant! I can help you find products, provide recommendations, and answer questions about your shopping experience.</span>
            </p>
            <p class="bot-message">
              <span class="bot-message-text">‚ú® I'm powered by advanced AI agents for more intelligent recommendations. What can I help you with today?</span>
            </p>
            <div id="assistant-status" class="assistant-status" style="display: none;">
              <span class="status-indicator agent-mode">ü§ñ AI Agent Mode</span>
              <span class="status-indicator legacy-mode" style="display: none;">üìù Legacy Mode</span>
            </div>
          </div>
          <div class="bot-input">
            <input id="bot-input-text" type="text" style="margin-right: 30px;" class="bot-input-text" placeholder="Recommend me items...">
            <input type="file" class="bot-input-file-button"  onchange="getBase64()">
            <button id="bot-input-button" class="bot-input-button">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  var image;
  function getBase64 ()  {
    var file = document.querySelector('input[type=file]')['files'][0];
    var reader = new FileReader();
    var baseString;
    reader.onloadend = function () {
      baseString = reader.result;
      console.log(baseString);
      image = baseString;
    };
    reader.readAsDataURL(file);
  }

  function extractIdsFromString(message) {
    const idPattern = /\[([a-zA-Z0-9-]+)\]/g;
    const matches = message.matchAll(idPattern);
    const ids = [];
    for (const match of matches) {
      ids.push(match[1]);
    }

    return ids;
  }

  const chatModal = document.getElementById("chat-modal");
  const botMessages = document.getElementById("bot-messages");
  const botbutton = document.getElementById("bot-input-button");
  const botinput = document.getElementById("bot-input-text");
  const assistantStatus = document.getElementById("assistant-status");
  
  let isAgentMode = true; // Will be determined by feature flags

  async function main() {
    botbutton.addEventListener("click", handleButtonClick);

    botinput.addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        botbutton.click();
      }
    });
    
    // Load feature flags to determine assistant mode
    await loadAssistantFeatureFlags();
    updateStatusIndicator();
  }
  
  async function loadAssistantFeatureFlags() {
    try {
      const response = await fetch("{{ $.baseUrl }}/api/feature-flags");
      if (response.ok) {
        const flags = await response.json();
        isAgentMode = flags.agent_assistant_enabled !== false;
        console.log("Assistant mode:", isAgentMode ? "AI Agent" : "Legacy");
      }
    } catch (error) {
      console.log("Feature flags not available, using default mode");
      isAgentMode = true;
    }
  }
  
  function updateStatusIndicator() {
    if (assistantStatus) {
      assistantStatus.style.display = 'block';
      const agentIndicator = assistantStatus.querySelector('.agent-mode');
      const legacyIndicator = assistantStatus.querySelector('.legacy-mode');
      
      if (isAgentMode) {
        agentIndicator.style.display = 'inline-block';
        legacyIndicator.style.display = 'none';
      } else {
        agentIndicator.style.display = 'none';
        legacyIndicator.style.display = 'inline-block';
      }
    }
  }

  async function handleButtonClick() {
    if(!botinput.value || !botinput.value.trim){
      return;
    }

    // Construct and render user message
    console.log("bot button clicked");
    const message = botinput.value;
    console.log("message: " + message);
    const usermessage = document.createElement("p");
    const userMessageSpan = document.createElement("span");
    userMessageSpan.innerText = message;
    userMessageSpan.classList.add("user-message-text");
    usermessage.classList.add("user-message");
    usermessage.appendChild(userMessageSpan);
    botMessages.appendChild(usermessage);
    
    // Only add image if one was provided
    if (image && image !== "undefined") {
      const imageDivElement = document.createElement("div");
      imageDivElement.classList.add("user-image-div")
      const imageElement = document.createElement("img");
      imageElement.src = image;
      imageElement.classList.add("user-image");
      imageElement.onerror = function() { this.style.display = 'none'; };
      imageDivElement.appendChild(imageElement);
      botMessages.appendChild(imageDivElement);
    }
    botMessages.scrollTo(0, botMessages.scrollHeight);
    botinput.value = "";

    // Disable send button and input field
    botbutton.disabled = true;
    botinput.disabled = true;
    console.log("bot is typing");

    // Construct and render placeholder bot message
    const botMessage = document.createElement("p");
    botMessage.classList.add("bot-message-loading");
    const botMessageSpan = document.createElement("span");
    botMessageSpan.innerText = ""
    botMessageSpan.classList.add("bot-message-text");
    botMessage.classList.add("bot-message");
    botMessage.appendChild(botMessageSpan);
    botMessages.appendChild(botMessage);
    botMessages.scrollTo(0, botMessages.scrollHeight);

    try {
      // Request a response from the Shopping Assistant
      const response = await fetch("{{ $.baseUrl }}/bot", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          message: message,
          image: image
        }),
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const responseJson = await response.json();
      console.log("Assistant response:", responseJson);

      // Handle enhanced agent response format
      if (responseJson.products && Array.isArray(responseJson.products)) {
        // Enhanced response with direct product data
        botMessageSpan.innerText = responseJson.message || "Here are some recommendations for you!";
        botMessage.classList.remove("bot-message-loading");
        
        await renderProductsFromData(responseJson.products);
      } else {
        // Legacy response format - extract product IDs from message
        const extractedIds = extractIdsFromString(responseJson.message);
        console.log("Extracted product IDs:", extractedIds);

        // Replace the placeholder bot message text with the real response
        // Making sure to remove any lists or product IDs from that message
        botMessageSpan.innerText = responseJson.message.replace(/\n+[-*\d][\S\s]*/g, "");
        botMessage.classList.remove("bot-message-loading");

        // If there are any product IDs, render them
        if (extractedIds.length > 0) {
          await renderProductsFromIds(extractedIds);
        }
      }
    } catch (error) {
      console.error("Assistant request failed:", error);
      botMessageSpan.innerText = "Sorry, I'm having trouble right now. Please try again.";
      botMessage.classList.remove("bot-message-loading");
    }

    botMessages.scrollTo(0, botMessages.scrollHeight);

    // Re-enable button and input field
    botbutton.disabled = false;
    botinput.disabled = false;
    botinput.focus();
  }

  // Enhanced function to render products from direct data
  async function renderProductsFromData(products) {
    if (!products || products.length === 0) return;

    // List-style container
    const list = document.createElement("div");
    list.style.display = 'flex';
    list.style.flexDirection = 'column';
    list.style.gap = '12px';

    for (const product of products) {
      const id = product.id;

      // Try to fetch price and canonical image/name from product meta
      let meta = null;
      try {
        const res = await fetch("{{ $.baseUrl }}/product-meta/" + id);
        if (res.ok) meta = await res.json();
      } catch (_) {}

      const name = (product.name || (meta && meta.name) || 'Unknown Product');
      const picture = product.picture || product.product_image_url || (meta && meta.picture) || '/static/img/products/placeholder.jpg';
      const priceText = product.price ? new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(product.price) : formatPrice(meta);

      const row = document.createElement('a');
      row.href = "{{ $.baseUrl }}/product/" + id;
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.gap = '12px';
      row.style.padding = '10px 12px';
      row.style.border = '1px solid #eee';
      row.style.borderRadius = '10px';
      row.style.textDecoration = 'none';
      row.style.color = 'inherit';

      const thumb = document.createElement('img');
      thumb.src = picture;
      thumb.width = 72; thumb.height = 72;
      thumb.style.objectFit = 'contain';
      thumb.style.borderRadius = '8px';
      thumb.onerror = function(){ this.src = '/static/img/products/placeholder.jpg' };

      const info = document.createElement('div');
      info.style.display = 'flex';
      info.style.flexDirection = 'column';
      info.style.gap = '4px';

      const title = document.createElement('div');
      title.textContent = name;
      title.style.fontWeight = '600';
      title.style.lineHeight = '1.2';

      const price = document.createElement('div');
      price.textContent = priceText;
      price.style.color = '#333';

      info.appendChild(title);
      if (priceText) info.appendChild(price);
      row.appendChild(thumb);
      row.appendChild(info);
      list.appendChild(row);
    }

    botMessages.appendChild(list);
  }

  // Legacy function to render products from IDs (backward compatibility)
  async function renderProductsFromIds(extractedIds) {
    const list = document.createElement('div');
    list.style.display = 'flex';
    list.style.flexDirection = 'column';
    list.style.gap = '12px';

    for (const id of extractedIds) {
      try {
        const productResponse = await fetch("{{ $.baseUrl }}/product-meta/" + id, { method: 'GET' });
        if (!productResponse.ok) continue;
        const product = await productResponse.json();

        const name = product.name;
        const picture = product.picture || '/static/img/products/placeholder.jpg';
        const priceText = product.price ? new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(product.price) : formatPrice(product);

        const row = document.createElement('a');
        row.href = "{{ $.baseUrl }}/product/" + id;
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '12px';
        row.style.padding = '10px 12px';
        row.style.border = '1px solid #eee';
        row.style.borderRadius = '10px';
        row.style.textDecoration = 'none';
        row.style.color = 'inherit';

        const thumb = document.createElement('img');
        thumb.src = picture; thumb.width = 72; thumb.height = 72;
        thumb.style.objectFit = 'contain';
        thumb.style.borderRadius = '8px';
        thumb.onerror = function(){ this.src = '/static/img/products/placeholder.jpg' };

        const info = document.createElement('div');
        info.style.display = 'flex';
        info.style.flexDirection = 'column';
        info.style.gap = '4px';

        const title = document.createElement('div');
        title.textContent = name;
        title.style.fontWeight = '600';

        const price = document.createElement('div');
        price.textContent = priceText;
        price.style.color = '#333';

        info.appendChild(title);
        if (priceText) info.appendChild(price);
        row.appendChild(thumb);
        row.appendChild(info);
        list.appendChild(row);
      } catch (_) {}
    }

    botMessages.appendChild(list);
  }

  // Helper: format price from product meta (supports priceUsd structure)
  function formatPrice(meta) {
    if (!meta) return '';
    if (meta.price && typeof meta.price === 'string') return meta.price;
    const p = meta.priceUsd || meta.priceUSD || null;
    if (!p) return '';
    const units = Number(p.units || 0);
    const nanos = Number(p.nanos || 0);
    const value = units + nanos / 1e9;
    const code = p.currencyCode || 'USD';
    try {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: code }).format(value);
    } catch (_) {
      return code + ' ' + value.toFixed(2);
    }
  }

  main();
</script>

{{ end }}
